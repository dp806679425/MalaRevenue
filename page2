<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>实收计算</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;padding:15px;background:#f5f5f7}
  h2{text-align:center;margin:10px 0 14px}

  .nav{display:flex;gap:10px;margin-bottom:12px}
  .nav a{flex:1;text-decoration:none;text-align:center;padding:12px;border-radius:12px;background:#fff;border:1px solid #e5e5e5;color:#111}
  .nav a.active{background:#007aff;color:#fff;border:none}

  .card{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px}
  .title{font-weight:900;margin-bottom:10px}
  .line{display:flex;gap:10px;align-items:center;margin:10px 0}
  .line label{flex:0 0 96px;color:#333}
  .line input{
    flex:1;font-size:16px;padding:10px;border-radius:10px;border:1px solid #ccc;
    text-align:right;background:#fff;
  }
  .tapInput{
    cursor:pointer;
  }
  .hint{font-size:13px;color:#666;margin-top:6px}

  .row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;font-size:16px;border-bottom:1px solid #eee}
  .row:last-child{border-bottom:none}
  .value{font-weight:900;min-width:120px;text-align:right}

  .btn{width:100%;padding:14px;font-size:17px;background:#007aff;color:#fff;border:none;border-radius:12px;margin-top:10px}

  /* ===== Modal ===== */
  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.35);
    display:none;
    align-items:center; justify-content:center;
    padding:16px;
    z-index:9999;
  }
  .modal{
    width:min(420px, 100%);
    background:#fff;
    border-radius:16px;
    padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
  }
  .modalHeader{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:8px;
  }
  .modalTitle{font-weight:900;font-size:16px}
  .closeBtn{
    border:none;background:#f2f2f2;border-radius:10px;padding:8px 10px;font-weight:800;
  }
  .display{
    background:#f5f5f7;border-radius:12px;padding:12px;
    text-align:right;
  }
  .expr{font-size:18px;font-weight:900;word-break:break-all;min-height:26px}
  .res{margin-top:6px;font-size:14px;color:#333}

  .keypad{
    display:grid;
    grid-template-columns:repeat(4, 1fr);
    gap:10px;
    margin-top:12px;
  }
  .kbtn{
    padding:14px 0;
    border-radius:12px;
    border:1px solid #ddd;
    background:#fff;
    font-size:18px;
    font-weight:800;
  }
  .kbtn.op{background:#f3f6ff;border-color:#d8e2ff}
  .kbtn.warn{background:#fff4f4;border-color:#ffd0d0}
  .kbtn.ok{background:#eefaf0;border-color:#cdeed3}

  .modalFooter{
    display:flex; gap:10px; margin-top:12px;
  }
  .fbtn{
    flex:1;
    padding:12px;
    border-radius:12px;
    border:none;
    font-size:16px;
    font-weight:900;
  }
  .fbtn.cancel{background:#f2f2f2}
  .fbtn.confirm{background:#007aff;color:#fff}
</style>
</head>

<body>
<h2>实收计算</h2>

<div class="nav">
  <a href="index.html">页面 1：底钱</a>
  <a class="active" href="page2.html">页面 2：实收</a>
</div>

<div class="card">
  <div class="title">剩余现金</div>
  <div class="line">
    <label>金额 (£)</label>
    <input type="number" id="leftCash" placeholder="例如 80" inputmode="decimal">
  </div>
  <div class="hint">手动输入收银机里剩余现金（£）。</div>
</div>

<div class="card">
  <div class="title">现金支出</div>
  <div class="line">
    <label>金额 (£)</label>
    <input class="tapInput" type="text" id="expenseInput" value="0.00" readonly>
  </div>
  <div class="hint">点击金额，弹出计算器。</div>
</div>

<div class="card">
  <div class="title">小费</div>
  <div class="line">
    <label>金额 (£)</label>
    <input class="tapInput" type="text" id="tipInput" value="0.00" readonly>
  </div>
  <div class="hint">点击金额，弹出计算器。</div>
</div>

<div class="card">
  <div class="title">计算结果</div>
  <div class="row">
    <div>现金收入 = 剩余现金 + 现金支出 − 小费</div>
    <div class="value">£<span id="income">0.00</span></div>
  </div>
  <button class="btn" onclick="resetAll()">一键清零</button>
</div>

<!-- ===== Modal ===== -->
<div class="overlay" id="overlay">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div class="modalTitle" id="modalTitle">计算器</div>
      <button class="closeBtn" onclick="closeModal(false)">关闭</button>
    </div>

    <div class="display">
      <div class="expr" id="mExpr">0</div>
      <div class="res">结果：£<span id="mVal">0.00</span></div>
    </div>

    <div class="keypad">
      <button class="kbtn" onclick="tap('7')">7</button>
      <button class="kbtn" onclick="tap('8')">8</button>
      <button class="kbtn" onclick="tap('9')">9</button>
      <button class="kbtn op" onclick="tap('/')">÷</button>

      <button class="kbtn" onclick="tap('4')">4</button>
      <button class="kbtn" onclick="tap('5')">5</button>
      <button class="kbtn" onclick="tap('6')">6</button>
      <button class="kbtn op" onclick="tap('*')">×</button>

      <button class="kbtn" onclick="tap('1')">1</button>
      <button class="kbtn" onclick="tap('2')">2</button>
      <button class="kbtn" onclick="tap('3')">3</button>
      <button class="kbtn op" onclick="tap('-')">−</button>

      <button class="kbtn" onclick="tap('0')">0</button>
      <button class="kbtn" onclick="tap('.')">.</button>
      <button class="kbtn op" onclick="tap('(')">(</button>
      <button class="kbtn op" onclick="tap(')')">)</button>

      <button class="kbtn warn" onclick="backspace()">⌫</button>
      <button class="kbtn warn" onclick="clearExpr()">C</button>
      <button class="kbtn ok" onclick="evaluateNow()">=</button>
      <button class="kbtn op" onclick="tap('+')">+</button>
    </div>

    <div class="modalFooter">
      <button class="fbtn cancel" onclick="closeModal(false)">取消</button>
      <button class="fbtn confirm" onclick="closeModal(true)">确定</button>
    </div>
  </div>
</div>

<script>
let currentTarget = null; // 'expense' or 'tip'

function safeEval(expr){
  const s = (expr || '').trim();
  if(!s) return 0;
  if(!/^[0-9+\-*/().\s]+$/.test(s)) return NaN;
  try{
    const v = Function('"use strict";return (' + s + ')')();
    if(typeof v !== 'number' || !isFinite(v)) return NaN;
    return v;
  }catch(e){ return NaN; }
}

function openModal(target){
  currentTarget = target;
  document.getElementById('modalTitle').textContent = (target==='expense') ? '现金支出 计算器' : '小费 计算器';

  // 读取当前值，作为初始表达式（纯数字）
  const inputId = (target==='expense') ? 'expenseInput' : 'tipInput';
  const val = document.getElementById(inputId).value || '0.00';
  const num = Number(val.replace('£','')) || 0;

  document.getElementById('mExpr').textContent = (num===0 ? '0' : String(num));
  updateModalResult();

  const ov = document.getElementById('overlay');
  ov.style.display = 'flex';
}

function closeModal(apply){
  const ov = document.getElementById('overlay');
  if(apply && currentTarget){
    const v = getModalValue();
    const out = v.toFixed(2);
    if(currentTarget==='expense') document.getElementById('expenseInput').value = out;
    if(currentTarget==='tip') document.getElementById('tipInput').value = out;
    recalcIncome();
  }
  ov.style.display = 'none';
  currentTarget = null;
}

function getModalValue(){
  const expr = document.getElementById('mExpr').textContent.trim();
  const v = safeEval(expr);
  return isNaN(v) ? 0 : v;
}

function updateModalResult(){
  document.getElementById('mVal').textContent = getModalValue().toFixed(2);
}

function tap(ch){
  const el = document.getElementById('mExpr');
  let s = el.textContent.trim();
  if(s === '0') s = '';
  s += ch;
  el.textContent = s || '0';
  updateModalResult();
}

function backspace(){
  const el = document.getElementById('mExpr');
  let s = el.textContent.trim();
  if(s === '0') return;
  s = s.slice(0,-1);
  if(!s) s = '0';
  el.textContent = s;
  updateModalResult();
}

function clearExpr(){
  document.getElementById('mExpr').textContent = '0';
  updateModalResult();
}

function evaluateNow(){
  // 这里 = 只是刷新结果
  updateModalResult();
}

function recalcIncome(){
  const left = Number(document.getElementById('leftCash').value || 0);
  const expense = Number(document.getElementById('expenseInput').value || 0);
  const tip = Number(document.getElementById('tipInput').value || 0);
  const income = left + expense - tip;
  document.getElementById('income').textContent = income.toFixed(2);
}

function resetAll(){
  document.getElementById('leftCash').value = '';
  document.getElementById('expenseInput').value = '0.00';
  document.getElementById('tipInput').value = '0.00';
  recalcIncome();
}

document.getElementById('leftCash').addEventListener('input', recalcIncome);
document.getElementById('expenseInput').addEventListener('click', ()=>openModal('expense'));
document.getElementById('tipInput').addEventListener('click', ()=>openModal('tip'));

// 点击遮罩空白处关闭
document.getElementById('overlay').addEventListener('click', (e)=>{
  if(e.target.id === 'overlay') closeModal(false);
});

recalcIncome();
</script>

</body>
</html>